apiVersion: apps/v1
kind: Deployment

metadata:
  name: {{ .Values.name }}-deployment
  namespace: {{ .Values.namespace }}
  labels:
    role: git2consul

spec:
  selector:
    matchLabels:
      pod: git2consul

  replicas: {{ .Values.replicaCount }}
  template:
    metadata:
      name: {{ .Values.name }}-pod
      labels:
        pod: git2consul

    spec:
      containers:
      - name: {{ .Values.name }}
        image: {{ .Values.img }}
        imagePullPolicy: {{ .Values.pullPolicy }}
        args: ["--endpoint", "consul.lbtran.com", "--port", "80"]

      # consul agent - service discovery
      - name: {{ .Values.name }}-consul-agent
        image: consul
        imagePullPolicy: {{ .Values.pullPolicy }}
        env:
        - name: "GOSSIP_KEY"
          valueFrom:
            secretKeyRef:
              name: consul-join-key
              key: consul_key
        - name: CONSUL_LOCAL_CONFIG
          value: |
            {
                "service": {
                    "name": "nodejs-3000",
                    "tags": [
                        "nodejs"
                    ],
                    "port": 3000,
                    "check": {
                        "id": "listening_port_3000",
                        "name": "Check port 3000",
                        "http": "http://localhost:3000",
                        "method": "GET",
                        "timeout": "1s",
                        "interval": "10s"
                    }
                }
            }
        args: ["agent", "-join", "consul", "-encrypt", "$(GOSSIP_KEY)"]
